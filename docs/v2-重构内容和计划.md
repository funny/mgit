# MGIT Refactor Plan: Async Core, Modern UI & Dependency Overhaul

本计划旨在将 MGIT 重构为一个高性能、现代化、健壮的多仓库管理工具。我们将采用 Rust 1.92.0，引入 `tokio` 异步运行时，全面升级依赖库，并重构 UI/UX。

## 1. 基础设施与依赖升级 (Infrastructure & Dependencies)
### 1.1 目录结构调整 (Flat Structure)
扁平化工作区结构，重命名并重新组织，规范化辅助目录：
- `mgit-core/`: 核心业务逻辑 (Async, Tokio, Snafu)
- `mgit-shell/`: 交互抽象层 (Trait 定义)
- `mgit-cli/`: 命令行入口
- `mgit-gui/`: 图形界面入口
- `scripts/`: 构建与辅助脚本 (原 `util/`)
- `tests/`: 工作区级测试与环境
  - `gitea-env/`: Gitea Docker 环境 (原 `gitea_compose/`)
- `docs/imgs/`: 文档与 README 图片资源 (原 `imgs/`)

### 1.2 依赖库全面升级 (Target Versions)
我们将尽可能匹配您指定的版本，若版本不存在则使用该主版本号下的最新版：
- **Rust Toolchain**: `1.92.0`
- **Async Stack**:
  - `tokio` (替换 rayon)
  - `tracing` "0.1.44" (替换 log4rs)
  - `tracing-subscriber`, `tracing-appender`
- **Error Handling (Snafu)**:
  - `snafu`: 用于 `mgit-core` 及各层库的错误定义。它提供结构化的上下文收集 (`Context`) 和一等公民的 `Backtrace` 支持，便于精确定位并发环境下的错误源头。
  - `anyhow`: 可选用于 `main.rs` 顶层错误捕获，或直接使用 `snafu` 的 Report。
- **UI Stack**:
  - `egui`, `eframe`, `egui_extras`: "0.33.3"
  - `image`: "0.25.9"
  - `rfd`: "0.17.2"
- **Utilities**:
  - `clap`: "4.5.x"
  - `toml`: "0.8.x" / `toml_edit`: "0.26.x"
  - `serde`: "1.0.228"
  - `regex`: "1.12.2"
  - `globset`: "0.4.18"
  - `walkdir`: "2.5.0"
  - `indicatif`: "0.18.3"
  - `console`: "0.16.2"
  - `home`: "0.5.12"

## 2. 内部结构重构 (Internal Architecture)

### 2.1 mgit-core (领域驱动 + 依赖注入)
```text
mgit-core/
├── src/
│   ├── config/          (配置领域模型)
│   ├── git/             (Git 适配器 - Tokio Process)
│   ├── ops/             (业务逻辑 - 纯函数，依赖 Shell Trait)
│   ├── traits/          (核心接口定义)
│   │   └── shell.rs     (定义 ShellInteraction)
│   ├── error.rs         (统一错误定义 Snafu)
│   └── lib.rs
```

### 2.2 mgit-gui (MVVM + 资源管理)
```text
mgit-gui/
├── src/
│   ├── app/
│   │   ├── context.rs   (Egui Context)
│   │   └── bridge.rs    (Tokio Bridge / 消息总线)
│   ├── state/           (ViewModel - 纯数据)
│   ├── ui/              (View - 纯渲染)
│   │   ├── theme.rs     (语义化配色)
│   │   ├── assets.rs    (图标资源管理)
│   │   └── components/  (RepoCard, TabBar 等)
│   └── main.rs
```

### 2.3 mgit-cli (Shell 实现)
```text
mgit-cli/
├── src/
│   ├── commands/        (Clap 子命令)
│   ├── shell/           (ShellInteraction 的终端实现)
│   └── main.rs
```

## 3. 核心特性重构

### 3.1 异步与进程安全
- **并发模型**: 使用 `tokio::task` + `JoinSet`。
- **Process Guard**: 封装 `tokio::process::Command`。
  - **Windows**: 绑定 Job Object，确保主进程崩溃时子进程自动清理。
  - **Linux/macOS**: 使用 `PR_SET_PDEATHSIG` (Linux) 或其他机制防止僵尸进程。

### 3.2 交互抽象 (mgit-shell)
定义 `ShellInteraction` Trait，解耦核心逻辑与 UI：
- `fn warn(&self, msg: &str)`
- `fn ask_ssh_trust(&self, fingerprint: &str) -> bool`
- `fn ask_http_auth(&self) -> Option<Auth>`

### 3.3 结构化日志与追踪 (Unified Logging)
- **统一输出**: 移除旧版中每个仓库独立的日志文件，所有日志统一写入 `~/.mgit/log.txt`。
- **结构化上下文**: 使用 `tracing` 的 `span` 机制，每条日志自动携带 `repo_name` 等上下文信息，以便在 GUI 中进行逻辑分组和过滤。
- **过程性日志**: 在关键业务节点（如命令启动、SSH 握手、配置解析）增加过程性日志埋点，辅助排查问题。
- **Backtrace**: 确保 `ERROR` 级别日志包含完整的堆栈信息。

## 4. 执行路线图 (Roadmap)
1.  **Init**: 调整目录结构，创建 `mgit-shell`，更新 `Cargo.toml` (使用 workspace.dependencies)。
2.  **Clean**: 清理废弃依赖 (`lazy_static` -> `OnceLock`)，移除旧版独立日志写入逻辑。
3.  **Core Base**: 实现 `mgit-core` 的异步基础 (Git Process, Snafu Error, Traits)。
4.  **Logic Migration**: 迁移 `sync`, `fetch` 到异步。
5.  **GUI Foundation**: 搭建 `mgit-gui` 新架构 (App, Bridge, Theme)。
6.  **Feature**: 实现多 Tab、SSH 检测等高级功能。
